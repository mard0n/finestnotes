---
import Badge from "@components/Badge.tsx";
import Layout from "@layouts/Layout.astro";
import { createServerClient } from "@utils/api";
import { formatDate } from "@utils/date";
import { parseResponse } from "hono/client";
import ArticleActionBar from "./_components/ArticleActionBar.tsx";
import NoteViewer from "./_components/NoteViewer.astro";
import AuthorName from "@components/AuthorName.tsx";
import CommentSection from "@components/CommentSection.tsx";
import AnnotationViewer from "../../components/AnnotationViewer.tsx";
import UpvoteButton from "@components/UpvoteButton.tsx";

const { id } = Astro.params;
const user = Astro.locals.user;

if (!id) {
  throw new Error("Article ID is required");
}

const response = await createServerClient(Astro.request.headers).api.articles[
  ":id"
].$get({ param: { id: id } });
const article = await parseResponse(response);

if (!article) {
  throw new Error("Article not found");
}
---

<Layout>
  <main class="max-w-2xl mx-auto my-8 px-4">
    <ArticleActionBar client:load article={article} user={user} />
    <UpvoteButton client:load noteId={article.id} user={user} />
    <h1 class="heading">{article.title}</h1>
    {
      article.type === "page" && article.description && (
        <p class="text-sm mt-2 mb-3">{article.description}</p>
      )
    }
    <div class="text-xs text-gray-500 mb-4 mt-1">
      <AuthorName
        ownerId={article.author.id}
        ownerName={article.author.name}
        userId={user?.id}
        shouldAddBy={true}
      /> Â·
      <span title={new Date(article.createdAt).toLocaleDateString()}>
        {formatDate(article.createdAt)}
      </span>
    </div>
    {
      article.type === "note" ? (
        <NoteViewer note={article} />
      ) : (
        <AnnotationViewer annotation={article} />
      )
    }

    <div class="collapse collapse-arrow px-0 mt-10">
      <input id="projects-collapse" type="checkbox" checked={true} />
      <div class="collapse-title font-semibold px-0">Projects ({article.projects.length})</div>
      <div class="collapse-content text-sm px-0">
        <ul class="flex gap-2 flex-wrap">
          {
            article.projects.map((project) => (
              <Badge
                id={project.id}
                ownerId={project.author.id}
                ownerName={project.author.name}
                userId={Astro.locals.user?.id}
              >
                {project.name}
              </Badge>
            ))
          }
        </ul>
      </div>
    </div>
    <div class="mt-10">
      <CommentSection client:load noteId={id} currentUser={user} isOpen={true} />
    </div>
  </main>
</Layout>
