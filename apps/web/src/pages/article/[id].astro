---
import AnnotationViewer from "@components/Notes/editors-viewers/AnnotationViewer";
import Badge from "@components/ui/Badge";
import Layout from "@layouts/Layout.astro";
import { createServerClient } from "@utils/api";
import { formatDate } from "@utils/date";
import { parseResponse } from "hono/client";
import ArticleActionBar from "./_components/ArticleActionBar.tsx";
import NoteViewer from "./_components/NoteViewer.astro";
import AuthorName from "@components/ui/AuthorName";

const { id } = Astro.params;
const user = Astro.locals.user;

if (!id) {
  throw new Error("Article ID is required");
}

const response = await createServerClient(Astro.request.headers).api.articles[
  ":id"
].$get({ param: { id: id }, query: { userId: user?.id } });

console.log("Fetched article:", response);
const article = await parseResponse(response);

if (!article) {
  throw new Error("Article not found");
}
---

<Layout>
  <main class="max-w-2xl mx-auto my-8 px-4">
    <ArticleActionBar client:load article={article} user={user} />
    <h1 class="heading">{article.title}</h1>
    {
      article.type === "page" && article.description && (
        <p class="text-sm mt-2 mb-3">{article.description}</p>
      )
    }
    <div class="text-xs text-gray-500 mb-4 mt-1">
      <AuthorName
        ownerId={article.user.id}
        ownerName={article.user.name}
        userId={user?.id}
        shouldAddBy={true}
      /> Â·
      <span title={new Date(article.createdAt).toLocaleDateString()}>
        {formatDate(article.createdAt)}
      </span>
    </div>
    {
      article.type === "note" ? (
        <NoteViewer note={article} />
      ) : (
        <AnnotationViewer annotation={article} />
      )
    }

    <div class="divider mt-10">projects</div>
    <ul class="flex gap-2 flex-wrap">
      {
        article.projects.map((project) => (
          <Badge
            id={project.id}
            ownerId={project.owner.id}
            ownerName={project.owner.name}
            userId={Astro.locals.user?.id}
          >
            {project.name}
          </Badge>
        ))
      }
    </ul>
  </main>
</Layout>
