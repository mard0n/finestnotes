---
import Layout from "@layouts/Layout.astro";

const isLoggedIn = !!Astro.locals.user;
---

<Layout>
	{
		!isLoggedIn ? (
			<div class="hero min-h-[calc(100vh-74px)] bg-base-200">
				<div class="hero-content flex-col lg:flex-row-reverse gap-8 w-full max-w-6xl">
					<div class="text-center lg:text-left flex-1">
						<h1 class="text-5xl font-bold">Login to your account</h1>
						<p class="py-6 max-w-md">
							Welcome back! Please login to your account to access your saved highlights and collections.
						</p>
					</div>
					<div class="card bg-base-100 w-full max-w-sm shrink-0 shadow-2xl">
						<form id="login-form" class="card-body gap-3">
							<div id="error-message" class="alert alert-error hidden mb-4">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									class="h-6 w-6 shrink-0 stroke-current"
									fill="none"
									viewBox="0 0 24 24">
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
								</svg>
								<span id="error-text">Error! Login failed.</span>
							</div>
							
							<div class="form-control w-full">
								<label for="email" class="label mb-1">
									<span class="label-text">Email</span>
								</label>
								<input
									type="email"
									id="email"
									name="email"
									autocomplete="email"
									placeholder="email@example.com"
									class="input input-bordered w-full"
									required
								/>
							</div>
							
							<div class="form-control w-full">
								<label for="password" class="label mb-1">
									<span class="label-text">Password</span>
								</label>
								<input
									type="password"
									id="password"
									name="password"
									autocomplete="current-password"
									placeholder="Enter your password"
									class="input input-bordered w-full"
									required
								/>
								<label class="label mt-2">
									<a href="/auth/forgot-password" class="label-text-alt link link-primary">Forgot password?</a>
								</label>
							</div>
							
							<div class="form-control mt-6 w-full">
								<button type="submit" class="btn btn-primary w-full">Login</button>
							</div>
							
							<div class="divider">OR</div>
							
							<div class="text-center">
								<p class="text-sm">
									Don't have an account?{" "}
									<a href="/auth/signup" class="link link-primary">Sign up</a>
								</p>
							</div>
						</form>
					</div>
				</div>
			</div>
		) : (
			<div class="hero min-h-[calc(100vh-74px)] bg-base-200">
				<div class="hero-content text-center">
					<div class="max-w-md">
						<div class="loading loading-spinner loading-lg"></div>
						<p class="py-6 text-lg">Logging in...</p>
					</div>
				</div>
			</div>
		)
	}
</Layout>

<script>
	import { authClient, sendAuthToExtension } from "@utils/auth";

	const session = await authClient.getSession();

	if (session.data?.session.token) {
		const token = session.data.session.token;

		console.log("Already logged in with token:", token);
		try {
			const response = await sendAuthToExtension(
				token,
				"gnoknopednpdpmkemfmhanmpgmfnfhho",
			);
			console.log("Auth sent:", response);
		} catch (error) {
			console.error("Failed to send auth:", error);
		}
		window.location.href = "/";
	} else {
		const form = document.getElementById("login-form") as HTMLFormElement;
		const errorDiv = document.getElementById("error-message") as HTMLDivElement;
		const errorText = document.getElementById("error-text") as HTMLSpanElement;

		form?.addEventListener("submit", async (e) => {
			e.preventDefault();

			const formData = new FormData(form);
			const email = formData.get("email") as string;
			const password = formData.get("password") as string;

			if (!email || !password) {
				showError("Please fill in all fields");
				return;
			}

			// Show loading state
			const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
			const originalText = submitBtn.textContent;
			submitBtn.disabled = true;
			submitBtn.innerHTML = '<span class="loading loading-spinner"></span> Logging in...';

			try {
				// This runs in the browser, so cookies will be set correctly
				const { data, error } = await authClient.signIn.email({
					email,
					password,
				});

				if (error) {
					if (error.code === "403") {
						showError("Please verify your email before logging in.");
						submitBtn.disabled = false;
						submitBtn.textContent = originalText || "Login";
						return;
					}
					showError(error.message || "Login failed. Please try again.");
					submitBtn.disabled = false;
					submitBtn.textContent = originalText || "Login";
					return;
				}

				if (!data) {
					showError("Login failed. Please try again.");
					submitBtn.disabled = false;
					submitBtn.textContent = originalText || "Login";
					return;
				}

				console.log("Login response:", data);
				try {
					const response = await sendAuthToExtension(
						data.token,
						"gnoknopednpdpmkemfmhanmpgmfnfhho",
					); // TODO: Set id dynamically chrome, safari
					console.log("Auth sent:", response);
				} catch (error) {
					console.error("Failed to send auth:", error);
				}
				console.log("Redirect to /");

				window.location.href = "/";
			} catch (error) {
				console.error("Login error:", error);
				showError("An unexpected error occurred. Please try again.");
				submitBtn.disabled = false;
				submitBtn.textContent = originalText || "Login";
			}
		});

		function showError(message: string) {
			if (errorText) {
				errorText.textContent = message;
			}
			errorDiv.classList.remove("hidden");
			setTimeout(() => {
				errorDiv.classList.add("hidden");
			}, 5000);
		}
	}
</script>
