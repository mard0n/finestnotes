---
import Article from "@components/Article";
import AuthorName from "@components/ui/AuthorName";
import Layout from "@layouts/Layout.astro";
import { createServerClient } from "@utils/api";
import { parseResponse } from "hono/client";

const { id } = Astro.params;
const user = Astro.locals.user;

if (!id) {
  throw new Error("Article ID is required");
}

const response = await createServerClient(Astro.request.headers).api.projects[
  ":id"
].$get({ param: { id: id } });
console.log("Fetched project:", response);
const project = await parseResponse(response);

if (!project) {
  throw new Error("Project not found");
}

const isSubscribed =
  user?.id && project.subscribers?.some((sub: any) => sub.id === user!.id);
---

<Layout>
  <main class="article-container">
    <div class="flex justify-between items-start">
      <div class="flex-1">
        <h1 class="font-serif text-2xl text-black">{project.name}</h1>
        {
          project.description && (
            <p class="text-sm mt-2 mb-3">{project.description}</p>
          )
        }
        <div class="text-xs text-gray-500 mt-1">
          <AuthorName
            ownerId={project.ownerId}
            ownerName={project.owner.name}
            userId={user?.id}
            shouldAddBy={true}
          />
        </div>
      </div>
      {
        project.ownerId === Astro.locals.user?.id ? (
          <a href={`/notes?projectId=${id}`} class="btn btn-sm btn-soft mr-2">
            Edit Project
          </a>
        ) : (
          <button
            id="subscribe-btn"
            class:list={[
              "btn btn-sm",
              isSubscribed ? "btn-outline" : "btn-primary",
            ]}
            data-project-id={id}
            data-is-subscribed={isSubscribed}
          >
            {isSubscribed ? "Unsubscribe" : "Subscribe"}
          </button>
        )
      }
    </div>
    <ul class="flex flex-col list rounded-box mt-8">
      {
        project.notes.map((note) => (
          <Article
            id={note.id}
            title={note.title}
            description={note.type === "note" ? note.content : note.description}
            authorName={note.user.name}
            createdAt={note.createdAt}
            userId={user?.id}
            authorId={note.user.id}
          />
        ))
      }
    </ul>
  </main>
</Layout>

<script>
  import { client } from "@utils/api";
  import { parseResponse } from "hono/client";

  const subscribeBtn = document.getElementById(
    "subscribe-btn"
  ) as HTMLButtonElement;
  let isSubscribed = subscribeBtn?.dataset.isSubscribed === "true";

  subscribeBtn?.addEventListener("click", async () => {
    const projectId = subscribeBtn.dataset.projectId!;

    try {
      if (isSubscribed) {
        const res = await client.api.projects[":id"].subscribers.$delete({
          param: { id: projectId },
        });
        const data = await parseResponse(res);

        if (!data.success) {
          throw new Error(data.message || "Unsubscribe failed");
        }

        subscribeBtn.textContent = "Subscribe";
        subscribeBtn.classList.remove("btn-outline");
        subscribeBtn.classList.add("btn-primary");
        isSubscribed = false;
      } else {
        const res = await client.api.projects[":id"].subscribers.$post({
          param: { id: projectId },
        });
        const data = await parseResponse(res);

        if (!data.success) {
          throw new Error(data.message || "Subscribe failed");
        }

        subscribeBtn.textContent = "Unsubscribe";
        subscribeBtn.classList.remove("btn-primary");
        subscribeBtn.classList.add("btn-outline");
        isSubscribed = true;
      }
    } catch (error) {
      console.error("Failed to toggle subscription:", error);
      alert("Failed to update subscription. Please try again.");
    }
  });
</script>
