---
import Layout from "@layouts/Layout.astro";
import { createServerClient } from "@utils/api";
import { parseResponse } from "hono/client";
import Article from "@components/Article";

const client = createServerClient(Astro.request.headers);
const page = Astro.url.searchParams.get('page') || '1'
const res = await client.api.articles.$get({query: {
	page
}})
const articles = await parseResponse(res);
---

<Layout>
	<main class="article-container">
		<div role="tablist" class="tabs tabs-border gap-4">
			<a href="/" role="tab" class="tab tab-active font-bold before:border-base-300 before:w-full before:left-0 before:bg-base-300 p-0">Articles</a>
		</div>
		<ul class="list mt-8 rounded-none">
		{
			articles.map((article) => (
				<Article 
					id={article.id} 
					title={article.title}
					description={article.type === 'note' ? article.content : article.description} 
					createdAt={article.createdAt} 
					authorName={article.author.name} 
					authorId={article.author.id}
					userId={Astro.locals.user?.id}
				/>
			))
		}
		</ul>
		<button id="load-more">Load more</button>
	</main>
</Layout>


<script>
	document.getElementById("load-more")?.addEventListener("click", () => {
		const url = new URL(window.location.href);
		const currentPage = parseInt(url.searchParams.get('page') || '1', 10);
		url.searchParams.set('page', (currentPage + 1).toString());
		window.location.href = url.toString();
	});
</script>