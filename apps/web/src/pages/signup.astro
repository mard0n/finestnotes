---
import Layout from "@layouts/Layout.astro";

export const prerender = false;

// Check if user is already logged in
if (Astro.locals.user) {
	return Astro.redirect("/");
}
---

<Layout>
	<div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
		<div class="max-w-md w-full space-y-8">
			<div>
				<h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
					Create your account
				</h2>
				<p class="mt-2 text-center text-sm text-gray-600">
					Already have an account?{" "}
					<a href="/login" class="font-medium text-blue-600 hover:text-blue-500">
						Sign in
					</a>
				</p>
			</div>
			<form class="mt-8 space-y-6" id="signup-form">
				<div id="error-message" class="hidden p-3 mb-4 text-sm text-red-800 rounded-lg bg-red-50" role="alert"></div>
				<div class="rounded-md shadow-sm space-y-4">
					<div>
						<label for="name" class="block text-sm font-medium text-gray-700">
							Full Name
						</label>
						<input
							id="name"
							name="name"
							type="text"
							required
							class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
							placeholder="John Doe"
						/>
					</div>
					<div>
						<label for="email-address" class="block text-sm font-medium text-gray-700">
							Email address
						</label>
						<input
							id="email-address"
							name="email"
							type="email"
							autocomplete="email"
							required
							class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
							placeholder="john@example.com"
						/>
					</div>
					<div>
						<label for="password" class="block text-sm font-medium text-gray-700">
							Password
						</label>
						<input
							id="password"
							name="password"
							type="password"
							autocomplete="new-password"
							required
							class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
							placeholder="••••••••"
						/>
						<p class="mt-1 text-xs text-gray-500">Must be at least 8 characters</p>
					</div>
					<div>
						<label for="confirm-password" class="block text-sm font-medium text-gray-700">
							Confirm Password
						</label>
						<input
							id="confirm-password"
							name="confirm-password"
							type="password"
							autocomplete="new-password"
							required
							class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
							placeholder="••••••••"
						/>
					</div>
				</div>

				<div class="flex items-center">
					<input
						id="terms"
						name="terms"
						type="checkbox"
						required
						class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
					/>
					<label for="terms" class="ml-2 block text-sm text-gray-900">
						I agree to the{" "}
						<a href="#" class="text-blue-600 hover:text-blue-500">Terms and Conditions</a>
					</label>
				</div>

				<div>
					<button
						type="submit"
						class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
					>
						Create account
					</button>
				</div>
			</form>
			
			<div class="mt-6">
				<div class="relative">
					<div class="absolute inset-0 flex items-center">
						<div class="w-full border-t border-gray-300"></div>
					</div>
					<div class="relative flex justify-center text-sm">
						<span class="px-2 bg-gray-50 text-gray-500">Or continue with</span>
					</div>
				</div>
				<div class="mt-6 grid grid-cols-2 gap-3">
					<button
						type="button"
						class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
					>
						<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
							<path d="M6.29 18.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0020 3.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.073 4.073 0 01.8 7.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 010 16.407a11.616 11.616 0 006.29 1.84"></path>
						</svg>
					</button>
					<button
						type="button"
						class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
					>
						<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
							<path fill-rule="evenodd" d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z" clip-rule="evenodd"></path>
						</svg>
					</button>
				</div>
			</div>
		</div>
	</div>
</Layout>

<script>
	import { authClient } from "@utils/auth";

	const form = document.getElementById('signup-form') as HTMLFormElement;
	const errorDiv = document.getElementById('error-message') as HTMLDivElement;

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();
		
		const formData = new FormData(form);
		const name = formData.get('name') as string;
		const email = formData.get('email') as string;
		const password = formData.get('password') as string;
		const confirmPassword = formData.get('confirm-password') as string;

		// Validation
		if (!name || !email || !password || !confirmPassword) {
			showError('Please fill in all fields');
			return;
		}

		if (password !== confirmPassword) {
			showError('Passwords do not match');
			return;
		}

		if (password.length < 8) {
			showError('Password must be at least 8 characters');
			return;
		}

		try {
			// This runs in the browser, so cookies will be set correctly
			const response = await authClient.signUp.email({ 
				name,
				email, 
				password,
				fetchOptions: {
					onSuccess: () => {
						// Redirect on success
						window.location.href = '/';
					},
					onError: (ctx) => {
						showError(ctx.error.message || 'Signup failed. Please try again.');
					}
				}
			});

			console.log('Signup response:', response);
		} catch (error) {
			console.error('Signup error:', error);
			showError('An unexpected error occurred. Please try again.');
		}
	});

	function showError(message: string) {
		errorDiv.textContent = message;
		errorDiv.classList.remove('hidden');
		setTimeout(() => {
			errorDiv.classList.add('hidden');
		}, 5000);
	}
</script>
