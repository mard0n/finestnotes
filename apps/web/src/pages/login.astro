---
import Layout from "@layouts/Layout.astro";

console.log("Astro.locals.user", Astro.locals.user);
const isLoggedIn = !!Astro.locals.user;
---

<Layout>
	{
		!isLoggedIn ? (
			<div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
				<div class="max-w-md w-full space-y-8">
					<div>
						<h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
							Sign in to your account
						</h2>
						<p class="mt-2 text-center text-sm text-gray-600">
							Or{" "}
							<a
								href="/signup"
								class="font-medium text-blue-600 hover:text-blue-500"
							>
								create a new account
							</a>
						</p>
					</div>
					<form class="mt-8 space-y-6" id="login-form">
						<div
							id="error-message"
							class="hidden p-3 mb-4 text-sm text-red-800 rounded-lg bg-red-50"
							role="alert"
						/>
						<div class="rounded-md shadow-sm -space-y-px">
							<div>
								<label for="email-address" class="sr-only">
									Email address
								</label>
								<input
									id="email-address"
									name="email"
									type="email"
									autocomplete="email"
									required
									class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
									placeholder="Email address"
								/>
							</div>
							<div>
								<label for="password" class="sr-only">
									Password
								</label>
								<input
									id="password"
									name="password"
									type="password"
									autocomplete="current-password"
									required
									class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
									placeholder="Password"
								/>
							</div>
						</div>

						<div class="flex items-center justify-between">
							<div class="flex items-center">
								<input
									id="remember-me"
									name="remember-me"
									type="checkbox"
									class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
								/>
								<label
									for="remember-me"
									class="ml-2 block text-sm text-gray-900"
								>
									Remember me
								</label>
							</div>

							<div class="text-sm">
								<a
									href="#"
									class="font-medium text-blue-600 hover:text-blue-500"
								>
									Forgot your password?
								</a>
							</div>
						</div>

						<div>
							<button
								type="submit"
								class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
							>
								Sign in
							</button>
						</div>
					</form>
				</div>
			</div>
		) : (
			<div>Logging in...</div>
		)
	}
</Layout>

<script>
	import { authClient, sendAuthToExtension } from "@utils/auth";

	const session = await authClient.getSession();

	if (session.data?.session.token) {
		const token = session.data.session.token;

		console.log("Already logged in with token:", token);
		if (token) {
			try {
				const response = await sendAuthToExtension(
					token,
					"gnoknopednpdpmkemfmhanmpgmfnfhho",
				);
				console.log("Auth sent:", response);
			} catch (error) {
				console.error("Failed to send auth:", error);
			}
		}
	} else {
		const form = document.getElementById("login-form") as HTMLFormElement;
		const errorDiv = document.getElementById("error-message") as HTMLDivElement;

		form?.addEventListener("submit", async (e) => {
			e.preventDefault();

			const formData = new FormData(form);
			const email = formData.get("email") as string;
			const password = formData.get("password") as string;

			if (!email || !password) {
				showError("Please fill in all fields");
				return;
			}

			try {
				// This runs in the browser, so cookies will be set correctly
				const { data, error } = await authClient.signIn.email({
					email,
					password,
				});

				if (error) {
					showError(error.message || "Login failed. Please try again.");
					return;
				}

				if (!data) {
					showError("Login failed. Please try again.");
					return;
				}

				// const url = new URL(window.location.href);
				// const redirectParam = url.searchParams.get("redirect");
				// const token = data.token;
				// console.log("URL", url);
				// console.log("Redirect param", redirectParam);
				// console.log("Token", token);
				// // add token
				// if (redirectParam && token) {
				// 	const redirectUrl = new URL(redirectParam);
				// 	redirectUrl.searchParams.set("token", token);
				// 	console.log("Redirecting to:", redirectUrl.toString());

				// 	// window.location.href = redirectUrl
				// 	// return Astro.redirect(redirectUrl.toString());
				// }
				console.log("Login response:", data);
				try {
					const response = await sendAuthToExtension(
						data.token,
						"gnoknopednpdpmkemfmhanmpgmfnfhho",
					); // TODO: Set id dynamically chrome, safari
					console.log("Auth sent:", response);
				} catch (error) {
					console.error("Failed to send auth:", error);
				}
				// window.location.href = "/";
			} catch (error) {
				console.error("Login error:", error);
				showError("An unexpected error occurred. Please try again.");
			}
		});

		function showError(message: string) {
			errorDiv.textContent = message;
			errorDiv.classList.remove("hidden");
			setTimeout(() => {
				errorDiv.classList.add("hidden");
			}, 5000);
		}
	}
</script>
